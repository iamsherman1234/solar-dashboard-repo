name: Daily Solar Dashboard

on:
  workflow_dispatch: # Allow manual trigger button
  schedule:
    - cron: '0 0 * * *' # 00:00 UTC = 07:00 AM Cambodia (UTC+7)

permissions:
  contents: write # Needed for Releases

jobs:
  process-solar-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      # 1. DOWNLOAD DATA FROM GOOGLE DRIVE
      - name: Drive - Fetch Data
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: python drive_manager.py pre

      # 2. RUN YOUR EXISTING SCRIPTS
      - name: Run Processing Scripts
        run: |
          # Ensure folders exist
          mkdir -p Archives
          
          # Run consolidation (Moves files to Archives locally)
          python sites_table_nogui.py
          
          # Run dashboard generation
          python dashboard_generator.py

      # 3. UPLOAD RESULTS BACK TO DRIVE & SYNC ARCHIVES
      - name: Drive - Upload & Sync
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: python drive_manager.py post

      # 4. CREATE GITHUB RELEASE
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: report-${{ github.run_id }}
          name: Solar Report ${{ steps.date.outputs.date }}
          files: |
            installed_sites_production_*.xlsx
            installed_sites_dashboard_*.html
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
