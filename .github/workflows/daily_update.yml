name: Update Dashboard

on:
  schedule:
    # Runs at 7:00 AM Cambodia Time (00:00 UTC) on MONDAYS only
    - cron: '0 0 * * 1' 
  workflow_dispatch:     # Allows manual button click

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout content
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install packages
        run: pip install -r requirements.txt

      - name: Run script
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: python -u main.py

      # --- RENAME & PREPARE RELEASE FILES ---
      - name: Prepare Release Files
        run: |
          # Get current date string (e.g., 21112025)
          DATE_STR=$(date +'%d%m%Y')
          
          # 1. Rename HTML File
          # We copy instead of move so 'index.html' stays for the website deploy step
          cp index.html "${DATE_STR}_solar_dashboard.html"
          
          # 2. Rename Data File (if it exists)
          if [ -f dashboard_data.json ]; then
            cp dashboard_data.json "${DATE_STR}_dashboard_data.json"
            echo "DATA_NAME=${DATE_STR}_dashboard_data.json" >> $GITHUB_ENV
          else
            echo "DATA_NAME=" >> $GITHUB_ENV
          fi
          
          # Save variables for next steps
          echo "REPORT_NAME=${DATE_STR}_solar_dashboard.html" >> $GITHUB_ENV
          echo "TAG_NAME=report-${DATE_STR}" >> $GITHUB_ENV

      # --- OPTIONAL: UPLOAD ARTIFACT (For easy download from Actions tab) ---
      - name: Upload HTML Artifact
        uses: actions/upload-artifact@v4
        with:
          name: daily-report
          path: ${{ env.REPORT_NAME }}
          retention-days: 30

      # --- CREATE GITHUB RELEASE (Archives the files) ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Solar Dashboard: ${{ env.REPORT_NAME }}"
          files: |
            ${{ env.REPORT_NAME }}
            ${{ env.DATA_NAME }}
          body: "Automated weekly solar performance report."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- DEPLOY WEBSITE (Live View) ---
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          # We exclude source code but KEEP index.html and dashboard_data.json
          exclude_assets: '**/*.py,**/*.yml,**/*.txt,**/data/**,.gitignore,README.md,**/*.csv,**/*.xlsx,temp_master.parquet,requirements.txt,${{ env.REPORT_NAME }},${{ env.DATA_NAME }}'
          destination_dir: ./
          keep_files: true
          user_name: 'SolarBot'
          user_email: 'bot@solar.com'
