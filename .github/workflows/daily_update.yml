name: Update Dashboard

on:
  schedule:
    # Runs at 00:00 UTC (07:00 Cambodia Time) on MONDAYS
    - cron: '0 0 * * 1'
  workflow_dispatch:      # Allows manual button click

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout content
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install packages
        run: pip install -r requirements.txt

      - name: Run script
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        run: python -u main.py

      # --- PREPARE FILES FOR RELEASE ---
      - name: Prepare Release Artifacts
        run: |
          # 1. Generate a Date Tag (e.g., v2025.11.21)
          DATE_TAG=$(date +'%Y.%m.%d')
          echo "TAG_NAME=v$DATE_TAG" >> $GITHUB_ENV
          
          # 2. Find the generated HTML file (The one with the timestamp)
          # Since the runner is fresh, there will be only one file matching this pattern.
          HTML_FILE=$(ls installed_sites_dashboard_*.html | head -n 1)
          
          # 3. Zip the file (Easier to download)
          zip "Solar_Dashboard_Report_$DATE_TAG.zip" "$HTML_FILE"
          
          # 4. Save filename to variable for the next step
          echo "RELEASE_ASSET=Solar_Dashboard_Report_$DATE_TAG.zip" >> $GITHUB_ENV

      # --- CREATE GITHUB RELEASE ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Solar Dashboard: ${{ env.TAG_NAME }}"
          body: "Weekly automated solar performance report."
          files: ${{ env.RELEASE_ASSET }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
