name: Update Dashboard

on:
  schedule:
    # Runs at 7:00 AM Cambodia Time (00:00 UTC) on MONDAYS only
    - cron: '0 0 * * 1' 
  workflow_dispatch:     # Allows manual button click

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout content
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install packages
        run: pip install -r requirements.txt

      - name: Run script
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: python -u main.py

      # --- PREPARE RELEASE FILES ---
      - name: Prepare Release Archives
        run: |
          DATE_STR=$(date +'%d%m%Y')
          ZIP_NAME="Solar_Report_${DATE_STR}.zip"
          
          # 1. Copy files to dated versions (for internal ref if needed, but we zip generics)
          # Actually, we just zip the generic files directly into a dated zip.
          # This ensures the HTML inside looks for "dashboard_data.json" (generic) which exists inside the zip.
          
          zip -r $ZIP_NAME index.html dashboard_data.json
          
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
          echo "TAG_NAME=report-${DATE_STR}" >> $GITHUB_ENV

      # --- CREATE RELEASE (ZIP ONLY) ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Solar Report: ${{ env.ZIP_NAME }}"
          files: ${{ env.ZIP_NAME }}
          body: "Download the ZIP file to view the full interactive dashboard offline."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- DEPLOY WEBSITE (Live View) ---
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          # EXCLUDE: Zip files, dated HTML/JSON copies, source code, config files
          # INCLUDE: Generic index.html and dashboard_data.json (implicitly included by NOT being in this list)
          exclude_assets: '**/*.py,**/*.yml,**/*.txt,**/data/**,.gitignore,README.md,**/*.csv,**/*.xlsx,temp_master.parquet,requirements.txt,*.zip'
          destination_dir: ./
          keep_files: true
          user_name: 'SolarBot'
          user_email: 'bot@solar.com'
