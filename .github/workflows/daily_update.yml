name: Update Dashboard

on:
  schedule:
    - cron: '0 0 * * 1' # Mondays at 7 AM Cambodia
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout content
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install packages
        run: pip install -r requirements.txt

      - name: Run script
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        run: python -u main.py

      # --- SMART RELEASE STEP (Checks for file first) ---
      - name: Prepare Release Artifacts
        id: check_file
        run: |
          # Check if any HTML dashboard file was created
          if ls installed_sites_dashboard_*.html 1> /dev/null 2>&1; then
            echo "File found. Preparing release..."
            
            DATE_TAG=$(date +'%Y.%m.%d')
            echo "TAG_NAME=v$DATE_TAG" >> $GITHUB_ENV
            
            HTML_FILE=$(ls installed_sites_dashboard_*.html | head -n 1)
            cp "$HTML_FILE" "Solar_Dashboard_Report_$DATE_TAG.html"
            
            zip "Solar_Dashboard_Report_$DATE_TAG.zip" "Solar_Dashboard_Report_$DATE_TAG.html"
            
            echo "RELEASE_ASSET=Solar_Dashboard_Report_$DATE_TAG.zip" >> $GITHUB_ENV
            echo "HAS_NEW_DATA=true" >> $GITHUB_ENV
          else
            echo "No new dashboard generated (No new data)."
            echo "HAS_NEW_DATA=false" >> $GITHUB_ENV
          fi

      # Only run Release if we actually have new data
      - name: Create Release
        if: env.HAS_NEW_DATA == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Solar Dashboard: ${{ env.TAG_NAME }}"
          body: "Weekly automated solar performance report."
          files: ${{ env.RELEASE_ASSET }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Only deploy Pages if we have new data
      - name: Deploy to GitHub Pages
        if: env.HAS_NEW_DATA == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
          exclude_assets: '**/*.py,**/*.yml,**/*.txt,**/data/**,.gitignore,README.md,**/*.csv,**/*.xlsx,*.parquet,requirements.txt,*.zip,installed_sites_dashboard_*.html'
          destination_dir: ./
          keep_files: false 
          user_name: 'SolarBot'
          user_email: 'bot@solar.com'
