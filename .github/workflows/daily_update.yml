name: Daily Solar Dashboard

on:
  workflow_dispatch: # Button to run manually
  schedule:
    - cron: '0 0 * * *' # 00:00 UTC = 07:00 AM Phnom Penh

permissions:
  contents: write # Needed for Releases

jobs:
  process-solar-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      # 1. DOWNLOAD DATA (Updated with Secrets)
      - name: Drive - Fetch Data
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        run: python drive_manager.py pre

      # 2. RUN PROCESSING
      - name: Run Processing Scripts
        run: |
          # Ensure folders exist
          mkdir -p Archives
          
          # Run consolidation
          python sites_table_nogui.py
          
          # Run dashboard generation
          python dashboard_generator.py

      # 3. UPLOAD RESULTS (Updated with Secrets)
      - name: Drive - Upload & Sync
        env:
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
        run: python drive_manager.py post

      # ... (after Drive Upload step) ...
      # ADD THIS STEP: Upload the HTML so the next workflow can see it
      - name: Share Dashboard for Hosting
        uses: actions/upload-artifact@v4
        with:
          name: solar-dashboard-html  # This is the ID we use to catch it later
          path: installed_sites_dashboard_*.html
          retention-days: 1
      # 4. PREPARE & RELEASE
      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # NEW STEP: Zip the files together
      - name: Zip Output Files
        run: |
          # The -j flag (junk paths) stores just the file names, not the folder structure
          zip -j Solar_Report_${{ steps.date.outputs.date }}.zip installed_sites_production_*.xlsx installed_sites_dashboard_*.html

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: report-${{ github.run_id }}
          name: Solar Report ${{ steps.date.outputs.date }}
          files: Solar_Report_${{ steps.date.outputs.date }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
